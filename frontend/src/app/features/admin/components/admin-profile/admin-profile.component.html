<app-notification
  [message]="(notificationService.notification$ | async)?.message ?? ''"
  [type]="(notificationService.notification$ | async)?.type ?? 'success'"
  [show]="(notificationService.notification$ | async)?.show ?? false"
></app-notification>

<div class="dashboard-wrapper">
  <!-- –°–∞–π–¥–±–∞—Ä -->
  <aside class="sidebar">
    <div style="text-align: center; margin-bottom: 30px">
      <img
        id="sidebarAvatar"
        src="/avatar.jpg"
        alt="Avatar"
        style="
          width: 100px;
          height: 100px;
          border-radius: 50%;
          object-fit: cover;
          margin-bottom: 10px;
        "
      />
      <h3 id="sidebarUsername" style="color: #333; font-size: 18px">
        {{ user.name }}
      </h3>
    </div>
    <nav class="sidebar-nav">
      @for (tab of tabs; track $index) {
      <a
        class="sidebar-link"
        (click)="currentPageSwitch(tab)"
        [class.active]="currentPage == tab"
        >{{ tab }}
      </a>

      }
      <a class="sidebar-link" id="log_out" (click)="logout()"> –í—ã–π—Ç–∏</a>
    </nav>
  </aside>

  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
  <main class="teacher-main">
    <!-- –û–ë–ó–û–† -->
    <section *ngIf="currentPage == '–û–±–∑–æ—Ä'" id="Review" class="teacher-section">
      <h2>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
      
      @if (dashboardLoading || !dashboardLoaded || !dashboardStats) {
        <div class="loading-spinner">
          <div class="spinner"></div>
          <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>
        </div>
      } @else {
        <div class="stats-grid">
          <div class="stat-tile">
            <div class="stat-icon">üìö</div>
            <span class="stat-number">{{ getFormattedNumber(dashboardStats?.total_courses) }}</span>
            <span class="stat-label">–ö—É—Ä—Å–æ–≤</span>
          </div>
          
          <div class="stat-tile">
            <div class="stat-icon">üë•</div>
            <span class="stat-number">{{ getFormattedNumber(dashboardStats?.total_students) }}</span>
            <span class="stat-label">–°—Ç—É–¥–µ–Ω—Ç–æ–≤</span>
          </div>
          
          <div class="stat-tile">
            <div class="stat-icon">üë®‚Äçüè´</div>
            <span class="stat-number">{{ getFormattedNumber(dashboardStats?.total_teachers) }}</span>
            <span class="stat-label">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π</span>
          </div>
          
          <div class="stat-tile">
            <div class="stat-icon">üèÜ</div>
            <span class="stat-number">{{ getFormattedNumber(dashboardStats?.total_certificates) }}</span>
            <span class="stat-label">–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤</span>
          </div>
          
          <div class="stat-tile">
            <div class="stat-icon">üí∞</div>
            <span class="stat-number">{{ getFormattedNumber(dashboardStats?.total_payments) }}</span>
            <span class="stat-label">–ü–ª–∞—Ç–µ–∂–µ–π</span>
          </div>
          
          <!-- <div class="stat-tile">
            <div class="stat-icon">üìà</div>
            <span class="stat-number">{{ getFormattedNumber(dashboardStats?.avg_revenue_per_student, 0) }}‚Ç∏</span>
            <span class="stat-label">–î–æ—Ö–æ–¥ –Ω–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞</span>
          </div>
           -->
          <!-- <div class="stat-tile">
            <div class="stat-icon">‚úÖ</div>
            <span class="stat-number">{{ getFormattedPercentage(dashboardStats?.certificate_completion_rate) }}%</span>
            <span class="stat-label">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤</span>
          </div>
           -->
          <!-- <div class="stat-tile">
            <div class="stat-icon">üìä</div>
            <span class="stat-number">{{ getFormattedPercentage(dashboardStats?.conversion_rate) }}%</span>
            <span class="stat-label">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</span>
          </div> -->
        </div>

        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="additional-stats">
          <h3>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
          <div class="additional-stats-grid">
            <div class="additional-stat-item">
              <i class="fas fa-calendar-week"></i>
              <div class="stat-content">
                <span class="stat-value">{{ getFormattedNumber(dashboardStats?.new_users_week) }}</span>
                <span class="stat-description">–ù–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞ –Ω–µ–¥–µ–ª—é</span>
              </div>
            </div>
            
            <div class="additional-stat-item">
              <i class="fas fa-calendar-month"></i>
              <div class="stat-content">
                <span class="stat-value">{{ getFormattedNumber(dashboardStats?.payments_month) }}</span>
                <span class="stat-description">–ü–ª–∞—Ç–µ–∂–µ–π –∑–∞ –º–µ—Å—è—Ü</span>
              </div>
            </div>
            
            <!-- <div class="additional-stat-item">
              <i class="fas fa-envelope"></i>
              <div class="stat-content">
                <span class="stat-value">{{ getFormattedNumber(dashboardStats?.messages_today) }}</span>
                <span class="stat-description">–°–æ–æ–±—â–µ–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è</span>
              </div>
            </div> -->
            
            <div class="additional-stat-item">
              <i class="fas fa-tasks"></i>
              <div class="stat-content">
                <span class="stat-value">{{ getFormattedNumber(dashboardStats?.total_assignments_submitted) }}</span>
                <span class="stat-description">–ó–∞–¥–∞–Ω–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
              </div>
            </div>
          </div>
        </div>
      }
    </section>

    <!-- –ö–£–†–°–´ -->
    @if (currentPage=="–ö—É—Ä—Å—ã") {
    <section id="Courses" class="teacher-section">
      <div class="course-header">
        <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–∞–º–∏</h2>
        <button class="add-btn" (click)="goToCreateCourse()">
          + –î–æ–±–∞–≤–∏—Ç—å –∫—É—Ä—Å
        </button>
        <div class="course-grid">
          <div id="courseList" class="course-list">
            <!-- –†–µ–∫—Ä—É—Ç–∏–Ω–≥ -->
            <div *ngFor="let course of courses" class="course-card">
              <div class="course-category">{{ course.category }}</div>
              <img src="{{ course.cover_url }}" alt="Recruiting" />
              <div class="course-info" (click)="goToEditCourse(course.id)">
                <h3>{{ course.title }}</h3>
                <p>{{ course.description }}</p>
                <p class="course-price">
                  <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> {{ course.price }}
                </p>
              </div>
            </div>

            <!-- –¢—É—Ç –ø–æ—è–≤–ª—è—é—Ç—Å—è –∫—É—Ä—Å—ã –∏–∑ localStorage -->
          </div>
        </div>
      </div>
      <!-- <div>
          <h1>Unpublished</h1>
          <div class="course-grid">
          <div id="courseList" class="course-list">
            
            <div *ngFor="let course of courses" class="course-card">
              <div class="course-category">{{ course.category }}</div>
              <img src="{{ course.cover_url }}" alt="Recruiting" />
              <div class="course-info">
                <h3>{{ course.title }}</h3>
                <p>{{ course.description }}</p>
                <p class="course-price">
                  <strong>–¶–µ–Ω–∞:</strong> {{ course.price }}
                </p>
              </div>
            </div>
  
            
          </div>
        </div>
      </div>  -->
    </section>
    }

    <!-- –ú–û–î–ê–õ–ö–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø / –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ö–£–†–°–ê -->
    <div
      id="editCourseModal"
      class="modal-overlay"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        justify-content: center;
        align-items: center;
      "
    >
      <div
        class="modal-content"
        style="
          background: #fff;
          padding: 30px;
          border-radius: 20px;
          width: 500px;
          max-height: 90vh;
          overflow: auto;
        "
      >
        <h3>–î–æ–±–∞–≤–∏—Ç—å / –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫—É—Ä—Å</h3>
        <input
          type="text"
          id="courseTitle"
          placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞"
          style="width: 100%; margin-bottom: 10px"
        />
        <textarea
          id="courseDesc"
          placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∫—É—Ä—Å–∞"
          style="width: 100%; margin-bottom: 10px"
        ></textarea>
        <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
        <input
          type="date"
          id="courseDeadline"
          style="width: 100%; margin-bottom: 10px"
        />

        <label>–û–±–ª–æ–∂–∫–∞ –∫—É—Ä—Å–∞:</label>
        <input
          type="file"
          id="courseImage"
          accept="image/*"
          style="margin-bottom: 10px"
        />

        <h4 style="margin-top: 15px">–ú–æ–¥—É–ª–∏</h4>
        <div id="modulesList"></div>
        <button
          type="button"
          onclick="addModule()"
          style="margin-top: 10px; margin-bottom: 20px"
        >
          + –î–æ–±–∞–≤–∏—Ç—å –º–æ–¥—É–ª—å
        </button>

        <div style="text-align: right">
          <button onclick="closeEditModal()" style="margin-right: 10px">
            –û—Ç–º–µ–Ω–∞
          </button>
          <button onclick="saveCourse()" class="edit-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- –ê–ù–ê–õ–ò–¢–ò–ö–ê -->
    <!-- @if (currentPage=='–ê–Ω–∞–ª–∏—Ç–∏–∫–∞') {

    <section id="analytics" class="teacher-section">
      <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
      <app-analytics-chart></app-analytics-chart>
    </section>
    } -->

    <!-- –°–û–û–ë–©–ï–ù–ò–Ø -->
    @if (currentPage == '–°–æ–æ–±—â–µ–Ω–∏—è') {

    <section id="messages" class="teacher-section">
      <h2>–°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</h2>
      <div class="message-box">
        <strong>–ò–≤–∞–Ω:</strong> –ù–µ –º–æ–≥—É –ø—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç –≤ –º–æ–¥—É–ª–µ 2.
        <input type="text" placeholder="–û—Ç–≤–µ—Ç–∏—Ç—å..." />
      </div>
    </section>

    } 
    
    @if (currentPage=='–ù–∞—Å—Ç—Ä–æ–π–∫–∏') {
    <section id="settings" class="teacher-section">
      <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</h2>
      <div class="profile-section">
        <!-- –§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è -->
        <div style="text-align: center; margin-bottom: 30px">
          <label for="profileImageInput" style="cursor: pointer">
            <img
              id="profileImagePreview"
              src="/avatar.jpg"
              alt="–ê–≤–∞—Ç–∞—Ä"
              style="
                width: 100px;
                height: 100px;
                border-radius: 50%;
                object-fit: cover;
                box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
              "
            />
          </label>
          <input
            type="file"
            id="profileImageInput"
            accept="image/*"
            style="display: none"
          />
          <p style="font-size: 14px; color: #777">
            –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ñ–æ—Ç–æ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å
          </p>
        </div>
        <div class="profile-form">
          <form [formGroup]="profileForm" (ngSubmit)="onSubmit()">
            <label>–ü–æ—á—Ç–∞</label>
            <input formControlName="email" type="email" />

            <label>–ò–º—è</label>
            <input formControlName="username" type="text" />

            <button type="submit" [disabled]="profileForm.invalid">
              –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
          </form>
        </div>
        <div class="profile-form">
          <form [formGroup]="passwordForm" (ngSubmit)="onChangePassword()">
            <label>–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å</label>
            <input formControlName="oldPassword" type="password" />

            <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
            <input formControlName="newPassword" type="password" />

            <label>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
            <input formControlName="confirmPassword" type="password" />

            <button type="submit" [disabled]="passwordForm.invalid">
              –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
            </button>
          </form>
        </div>
      </div>
    </section>
    }
    
    @if (currentPage == "–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å") {
    <section id="teachers" class="teacher-section">
      <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º–∏</h2>
      <div class="table-container">
        <table class="teachers-table">
          <thead>
            <tr>
              <th>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</th>
              <th>–ü–æ—á—Ç–∞</th>
              <th>–ö—É—Ä—Å—ã</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let teacher of allTeachers">
              <td class="teacher-name">{{ teacher.name }}</td>
              <td class="teacher-email">{{ teacher.email }}</td>
              <td class="teacher-courses">
                @for (course of teacher.courses; track $index) {
                <span class="course-badge">
                  {{ course.title }}
                  <span
                    class="delete-icon"
                    (click)="removeCourseFromTeacher(teacher, course.id)"
                  >
                    √ó
                  </span>
                </span>
                }
                <button (click)="openTeacherCoursesDialog(teacher)">
                  –î–æ–±–∞–≤–∏—Ç—å –ö—É—Ä—Å
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <button (click)="createTeacher()">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</button>
    </section>
    } @if (currentPage == '–ü–ª–∞—Ç–µ–∂–∏') {
    <section id="payments" class="teacher-section">
      <h2>–ü–ª–∞—Ç–µ–∂–∏</h2>
      @if (payments.length == 0) {
      <p class="no-payments">–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π</p>
      } @else {
      <div class="table-container">
        <table class="teachers-table">
          <thead>
            <tr>
              <th>–°—Ç—É–¥–µ–Ω—Ç</th>
              <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
              <th>–ö—É—Ä—Å</th>
              <th>–°—É–º–º–∞</th>
              <th>–î–∞—Ç–∞</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
            </tr>
          </thead>
          <tbody>
            @for (payment of payments; track $index) {
            <tr>
              <td class="teacher-name">{{ payment.user_name }}</td>
              <td>{{ payment.phone }}</td>
              <td>{{ payment.course_title }}</td>
              <td>{{ payment.amount }}</td>
              <td>{{ payment.created_at | date : "dd.MM.yyyy HH:mm" }}</td>
              <td>{{ payment.status }}</td>
              <td>
                @if (payment.status == 'pending') {
                <button class="invoice-btn" (click)="invoicePayment(payment)">
                  –í—ã—Å—Ç–∞–≤–∏—Ç—å —Å—á–µ—Ç
                </button>
                <button class="reject-btn" (click)="rejectPayment(payment)">
                  –û—Ç–∫–ª–æ–Ω–∏—Ç—å –ø–ª–∞—Ç–µ–∂
                </button>
                } @if (payment.status == 'invoiced') {
                <button class="approve-btn" (click)="approvePayment(payment)">
                  –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–ª–∞—Ç–µ–∂
                </button>
                <button class="reject-btn" (click)="rejectPayment(payment)">
                  –û—Ç–∫–ª–æ–Ω–∏—Ç—å –ø–ª–∞—Ç–µ–∂
                </button>
                }
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
      }
    </section>
    }

    @if(currentPage == "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤") {
      <section id="tests" class="teacher-section">
        <div class="tests-header">
          <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤</h2>
          <div class="tests-controls">
            <div class="tests-stats">
              <span class="total-results">–í—Å–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: {{ testsPagination.total }}</span>
            </div>
            <button class="import-btn" (click)="openTestImportDialog()">
              <i class="fas fa-upload"></i>
              –¢–µ—Å—Ç –∏–º–ø–æ—Ä—Ç
            </button>
          </div>
        </div>

        @if (!testsLoaded) {
          <div class="loading-spinner">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...</p>
          </div>
        } @else if (tests.length === 0) {
          <div class="no-results">
            <p>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
          </div>
        } @else {
          <div class="table-container">
            <table class="tests-table">
              <thead>
                <tr>
                  <th>–°—Ç—É–¥–µ–Ω—Ç</th>
                  <th>Email</th>
                  <th>–ö—É—Ä—Å</th>
                  <th>–ß–∞—Å—Ç—å</th>
                  <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                  <th>–ü—Ä–æ—Ü–µ–Ω—Ç</th>
                  <th>–î–∞—Ç–∞ —Å–¥–∞—á–∏</th>
                  <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody>
                @for (test of tests; track test.id) {
                <tr class="test-row" (click)="showTestDetails(test)">
                  <td class="student-name">
                    <div class="student-info">
                      <span class="name">{{ test.user_name }}</span>
                    </div>
                  </td>
                  <td class="student-email">{{ test.email }}</td>
                  <td class="course-title">
                    <span class="course-name">{{ test.course_title }}</span>
                  </td>
                  <td class="test-part">
                    <span class="part-badge">–ß–∞—Å—Ç—å {{ test.part }}</span>
                  </td>
                  <td class="test-score">
                    <span class="score-display">{{ test.score }}/{{ test.max_score }}</span>
                  </td>
                  <td class="test-percentage">
                    <span 
                      class="percentage-badge"
                      [style.background-color]="getScoreColor(test)"
                    >
                      {{ test.max_score > 0 ? ((test.score / test.max_score) * 100).toFixed(0) : 0 }}%
                    </span>
                  </td>
                  <td class="test-date">{{ test.submitted_at | date : "dd.MM.yyyy HH:mm" }}</td>
                  <td class="test-actions" (click)="$event.stopPropagation()">
                    <button 
                      class="view-details-btn"
                      (click)="showTestDetails(test)"
                      title="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏"
                    >
                      üëÅÔ∏è
                    </button>
                  </td>
                </tr>
                }
              </tbody>
            </table>
          </div>

          <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
          <div class="pagination-container" *ngIf="testsPagination.pages > 1">
            <div class="pagination">
              <button 
                class="pagination-btn prev"
                [disabled]="testsPagination.page <= 1"
                (click)="previousTestPage()"
              >
                ‚Üê –ù–∞–∑–∞–¥
              </button>
              
              <div class="page-numbers">
                @for (pageNum of [].constructor(testsPagination.pages); track $index; let i = $index) {
                  @if (i + 1 === testsPagination.page) {
                    <button class="pagination-btn current">{{ i + 1 }}</button>
                  } @else if (Math.abs((i + 1) - testsPagination.page) <= 2 || i + 1 === 1 || i + 1 === testsPagination.pages) {
                    <button 
                      class="pagination-btn"
                      (click)="goToTestPage(i + 1)"
                    >
                      {{ i + 1 }}
                    </button>
                  } @else if (Math.abs((i + 1) - testsPagination.page) === 3) {
                    <span class="pagination-dots">...</span>
                  }
                }
              </div>

              <button 
                class="pagination-btn next"
                [disabled]="testsPagination.page >= testsPagination.pages"
                (click)="nextTestPage()"
              >
                –í–ø–µ—Ä—ë–¥ ‚Üí
              </button>
            </div>
            
            <div class="pagination-info">
              <span>
                –ü–æ–∫–∞–∑–∞–Ω–æ {{ ((testsPagination.page - 1) * testsPagination.limit) + 1 }}-{{ 
                  Math.min(testsPagination.page * testsPagination.limit, testsPagination.total) 
                }} –∏–∑ {{ testsPagination.total }} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
              </span>
            </div>
          </div>
        }
      </section>
    }

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏ —Ç–µ—Å—Ç–∞ -->
    @if (showTestDetailsModal && selectedTest) {
      <div class="modal-overlay" (click)="closeTestDetailsModal()">
        <div class="test-details-modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3>–î–µ—Ç–∞–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ç–µ—Å—Ç–∞</h3>
            <button class="close-btn" (click)="closeTestDetailsModal()">√ó</button>
          </div>
          
          <div class="modal-content">
            <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="test-info-section">
              <h4>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—É–¥–µ–Ω—Ç–µ –∏ –∫—É—Ä—Å–µ</h4>
              <div class="info-grid">
                <div class="info-item">
                  <label>–°—Ç—É–¥–µ–Ω—Ç:</label>
                  <span>{{ selectedTest.user_name }}</span>
                </div>
                <div class="info-item">
                  <label>Email:</label>
                  <span>{{ selectedTest.email }}</span>
                </div>
                <div class="info-item">
                  <label>–ö—É—Ä—Å:</label>
                  <span>{{ selectedTest.course_title }}</span>
                </div>
                <div class="info-item">
                  <label>–ß–∞—Å—Ç—å —Ç–µ—Å—Ç–∞:</label>
                  <span>{{ selectedTest.part }}</span>
                </div>
                <div class="info-item">
                  <label>–†–µ–∑—É–ª—å—Ç–∞—Ç:</label>
                  <span class="score-info">{{ selectedTest.score }}/{{ selectedTest.max_score }} ({{ 
                    selectedTest.max_score > 0 ? ((selectedTest.score / selectedTest.max_score) * 100).toFixed(1) : 0 
                  }}%)</span>
                </div>
                <div class="info-item">
                  <label>–î–∞—Ç–∞ —Å–¥–∞—á–∏:</label>
                  <span>{{ selectedTest.submitted_at | date : "dd.MM.yyyy HH:mm" }}</span>
                </div>
              </div>
            </div>

            <!-- –î–µ—Ç–∞–ª–∏ —Ç–µ—Å—Ç–∞ -->
            @if (selectedTest.details) {
              <div class="test-details-section">
                <h4>–û—Ç–≤–µ—Ç—ã —Å—Ç—É–¥–µ–Ω—Ç–∞</h4>
                
                @if (selectedTest.details.headers && selectedTest.details.raw_data) {
                  <div class="answers-table">
                    <table class="details-table">
                      <tbody>
                        @for (header of selectedTest.details.headers; track $index; let i = $index) {
                          @if (i > 2) { <!-- –ü—Ä–æ–ø—É—Å–∫–∞–µ–º timestamp, email, score -->
                            <tr>
                              <td class="question-cell">{{ header }}</td>
                              <td class="answer-cell">{{ selectedTest.details.raw_data[i] || '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</td>
                            </tr>
                          }
                        }
                      </tbody>
                    </table>
                  </div>
                } @else {
                  <p class="no-details">–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–≤–µ—Ç–∞—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p>
                }

                <!-- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                @if (selectedTest.details.sheet_id) {
                  <div class="technical-info">
                    <h5>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                    <div class="tech-grid">
                      <div class="tech-item">
                        <label>ID —Ç–∞–±–ª–∏—Ü—ã:</label>
                        <span>{{ selectedTest.details.sheet_id }}</span>
                      </div>
                      <div class="tech-item">
                        <label>–°—Ç—Ä–æ–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ:</label>
                        <span>{{ selectedTest.details.row_number }}</span>
                      </div>
                      <div class="tech-item">
                        <label>–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ:</label>
                        <span>{{ selectedTest.details.imported_at | date : "dd.MM.yyyy HH:mm" }}</span>
                      </div>
                      @if (selectedTest.form_url) {
                        <div class="tech-item">
                          <label>–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ä–º—É:</label>
                          <a [href]="selectedTest.form_url" target="_blank" class="form-link">
                            –û—Ç–∫—Ä—ã—Ç—å –≤ Google Sheets
                          </a>
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
            }
          </div>
          
          <div class="modal-footer">
            <button class="close-modal-btn" (click)="closeTestDetailsModal()">
              –ó–∞–∫—Ä—ã—Ç—å
            </button>
          </div>
        </div>
      </div>
    }

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–º–ø–æ—Ä—Ç–∞ —Ç–µ—Å—Ç–æ–≤ -->
    @if (showTestImportModal) {
      <div class="modal-overlay" (click)="closeTestImportDialog()">
        <div class="import-modal" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3>
              <i class="fas fa-upload"></i>
              –ò–º–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤ –∏–∑ Google Sheets
            </h3>
            <button class="close-btn" (click)="closeTestImportDialog()">√ó</button>
          </div>
          
          <div class="modal-content">
            <form [formGroup]="testImportForm" (ngSubmit)="importTestResults()">
              
              <div class="form-group">
                <label for="sheetId">
                  <i class="fas fa-table"></i>
                  ID Google Sheets <span class="required">*</span>
                </label>
                <input 
                  id="sheetId"
                  type="text" 
                  formControlName="sheetId"
                  placeholder="1BxiU1VqoyXD6XNJKdxKVAAaZSGmP"
                  class="form-input"
                />
                <small class="help-text">
                  –°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID –∏–∑ URL Google Sheets: 
                  https://docs.google.com/spreadsheets/d/<strong>ID_–ó–î–ï–°–¨</strong>/edit
                </small>
              </div>

              <div class="form-group">
                <label for="courseId">
                  <i class="fas fa-graduation-cap"></i>
                  –ö—É—Ä—Å <span class="required">*</span>
                </label>
                <select 
                  id="courseId"
                  formControlName="courseId"
                  class="form-select"
                >
                  <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å</option>
                  @for (course of courses; track course.id) {
                    <option [value]="course.id">{{ course.title }}</option>
                  }
                </select>
              </div>

              <div class="form-group">
                <label for="part">
                  <i class="fas fa-layer-group"></i>
                  –ß–∞—Å—Ç—å —Ç–µ—Å—Ç–∞ <span class="required">*</span>
                </label>
                <input 
                  id="part"
                  type="number" 
                  formControlName="part"
                  min="1"
                  placeholder="1"
                  class="form-input"
                />
                <small class="help-text">–ù–æ–º–µ—Ä —á–∞—Å—Ç–∏ —Ç–µ—Å—Ç–∞ (–æ–±—ã—á–Ω–æ –æ—Ç 1 –¥–æ 10)</small>
              </div>

              <div class="form-group">
                <label for="range">
                  <i class="fas fa-border-all"></i>
                  –î–∏–∞–ø–∞–∑–æ–Ω —è—á–µ–µ–∫ <span class="required">*</span>
                </label>
                <input 
                  id="range"
                  type="text" 
                  formControlName="range"
                  placeholder="A1:Z1000"
                  class="form-input"
                />
                <small class="help-text">
                  –î–∏–∞–ø–∞–∑–æ–Ω —è—á–µ–µ–∫ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: A1:Z1000, Sheet1!A1:Z1000)
                </small>
              </div>

              <div class="info-box">
                <i class="fas fa-info-circle"></i>
                <div class="info-content">
                  <strong>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ñ–æ—Ä–º–∞—Ç—É —Ç–∞–±–ª–∏—Ü—ã:</strong>
                  <ul>
                    <li>–ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–ª–æ–Ω–æ–∫</li>
                    <li>–ö–æ–ª–æ–Ω–∫–∞ "email" –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</li>
                    <li>–ö–æ–ª–æ–Ω–∫–∞ "score" –∏–ª–∏ "–ë–∞–ª–ª" –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</li>
                    <li>–ö–æ–ª–æ–Ω–∫–∞ "timestamp" –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</li>
                  </ul>
                </div>
              </div>

              <div class="modal-actions">
                <button 
                  type="button" 
                  class="cancel-btn"
                  (click)="closeTestImportDialog()"
                >
                  <i class="fas fa-times"></i>
                  –û—Ç–º–µ–Ω–∞
                </button>
                <button 
                  type="submit" 
                  class="import-submit-btn"
                  [disabled]="testImportForm.invalid"
                >
                  <i class="fas fa-upload"></i>
                  –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    }
  </main>
</div>
